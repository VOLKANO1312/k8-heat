#SPDX-License-Identifier: MIT-0
---
# tasks file for k8s-master
- name: Add k8s GPG
  shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/Release.key |
    gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Add k8s repo
  shell: |
    echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] \
    https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/ /" \
    > /etc/apt/sources.list.d/kubernetes.list

- name: Install k8s packages
  apt:
    update_cache: yes
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: present

- name: Hold packages
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop:
    - kubelet
    - kubeadm
    - kubectl

- name: Check cluster already init
  stat:
    path: /etc/kubernetes/admin.conf
  register: k8s_init

- name: Init cluster
  shell: |
    kubeadm init \
      --apiserver-advertise-address={{ master_ip }} \
      --pod-network-cidr={{ pod_network_cidr }} \
      --cri-socket unix:///var/run/containerd/containerd.sock
  when: not k8s_init.stat.exists

- name: Setup kubeconfig for ubuntu
  shell: |
    mkdir -p /home/ubuntu/.kube
    cp /etc/kubernetes/admin.conf /home/ubuntu/.kube/config
    chown -R ubuntu:ubuntu /home/ubuntu/.kube

- name: Generate join command
  shell: kubeadm token create --print-join-command
  register: join_cmd

- name: Save join command
  copy:
    content: "{{ join_cmd.stdout }}"
    dest: /home/ubuntu/k8s-join-command.sh
    mode: '0755'

